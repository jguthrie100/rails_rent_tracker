<style type="text/css">
  .edit {
    visibility: hidden;
  }
  .display {
    visibility: visible;
  }
</style>

<% failed_edits = Hash.new %>
<h3 class="text-primary">List of <%= @desc %> Properties</h3>
<table class="table table-hover table-condensed table-striped">
  <thead>
    <tr>
      <th>&nbsp;</th>
      <th>Property Name</th>
      <th>Address</th>
      <th>&nbsp;</th>
    </tr>
  </thead>
  <tbody>
    <%# Create rows of Properties %>
    <%= form_for :properties, :url => update_multiple_properties_path, :method => "put" do |form| %>
      <% @properties.each do |property| %>

        <%# Populate failed_edits hash with list of errors if applicable %>
        <% (!params.nil? && params[property.id.to_s]) ? (failed_edits[property.id] = params[property.id.to_s]) : "" %>

        <%= fields_for "properties[]", property do |property_form| %>
          <tr id="property_row_<%= property.id %>" class="property_row" style="font-size: 11px">
            <td>
              <%# Checkbox %>
              <input id="checkbox_<%= property.id %>" class="checkbox" type="checkbox" onchange="toggle_edit(<%= property.id %>)" />
            </td>
            <td>
              <%# Property name (w/ link) / Property name edit field %>
              <%= link_to(property.name, property_path(property), class: "display name") %><br />
              <%= property_form.text_field(:name, class: "edit name", value: "#{failed_edits[property.id] ? failed_edits[property.id][:name] : property.name}") %>
            </td>
            <td>
              <%# Property address (w/ map link) / Property address edit field %>
              <span class="display name"><%= property.address %> - <%= link_to("[map]", "http://www.google.com/maps/search/#{property.address}", :target => "_blank") %></span><br />
              <%= property_form.text_field(:address, class: "edit name", size: 100, value: "#{failed_edits[property.id] ? failed_edits[property.id][:address] : property.address}") %>
            </td>
            <td>
              <% is_updated_id = "properties_" + property.id.to_s + "_is_updated" %>
              <%= property_form.hidden_field(:is_updated, :value => 'false') %>

              <%# Save button %>
              <button id="save_btn_<%= property.id %>" class="fa fa-floppy-o btn btn-primary disabled" onclick="document.getElementById('<%= is_updated_id %>').value='true'" disabled></button>

              <%# Archive/Unarchive button (w/ confirm message) %>
              <% if !property.archived %>
                <%= link_to "", {:controller => :properties, :action => 'archive', :id => property.id }, :method => :patch, class: "fa fa-minus-square btn btn-danger", data: { confirm: "Are you sure you want to archive property '#{property.name.upcase}' and remove it from your current list of properties? (This change can be reversed later..)" } %>
              <% else %>
                <%= link_to "", {:controller => :properties, :action => 'unarchive', :id => property.id }, :method => :patch, class: "fa fa-plus-square btn btn-warning", data: { confirm: "Are you sure you want to restore property '#{property.name.upcase}' and add it to your list of current properties? (This change can be reversed later..)" } %>
              <% end %>
            </td>
          </tr>
        <% end %>
      <% end %>
    <% end %>
        <%# Create final row with a form to add a new Property to the inventory %>
        <%= form_tag(properties_path) do %>
          <% (!params.nil? && params['new']) ? (failed_edits['new'] = params['new']) : "" %>
          <tr id="property_row_new" class="property_row" style="font-size: 11px">
            <td>
              <%# Checkbox %>
              <input id="checkbox_new" class="checkbox new_property" type="checkbox" onchange="toggle_edit('new')" />
            </td>
            <td>
              <%# Property name edit field %>
              <%= text_field(:property, :name, disabled: "true", class: "display edit name", value: "#{failed_edits['new'] ? failed_edits['new'][:name] : ''}") %>
            </td>
            <td>
              <%# Property address edit field %>
              <%= text_field(:property, :address, :size => 100, disabled: "true", class: "display edit address", value: "#{failed_edits['new'] ? failed_edits['new'][:address] : ''}") %>
            </td>
            <td>
              <%# Save button %>
              <button id="save_btn_new" class="fa fa-floppy-o btn btn-primary disabled new_property" disabled></button>
            </td>
          </tr>
        <% end %>
  </tbody>
</table>

<script>

// On load we want to select the error'd rows and highlight the fields that raised an error
$(document).ready(function() {
  $(".edit").prop("disabled", true);

//  <%# Automatically select and highlight row that failed to update/be saved and threw the error %>
  <% failed_edits.keys.each do |property_id| %>
    <% property_id.is_a?(String) ? (property_id_s = "'#{property_id}'".html_safe) : (property_id_s = property_id) %>
    $("#checkbox_" + <%= property_id_s %>).prop("checked", true);
    toggle_edit(<%= property_id_s %>);

//    <%# Highlight the attributes that were the reason for the error %>
    <% failed_edits[property_id].keys.each do |attr| %>
      <% next unless failed_edits[property_id][:errors].include? attr %>
      $(".<%= attr %>.edit", "#property_row_" + <%= property_id_s %>).css("background-color", "rgba(255,0,0,0.5)");
    <% end %>
  <% end %>
});

// Method that gets called everytime a checkbox is selected
function toggle_edit(id) {
  if ( $("#checkbox_" + id).prop("checked") ) {
    // WHEN A ROW IS SELECTED..

    // Enable the Save button
    $("#save_btn_" + id).removeClass("disabled")
                        .prop("disabled", false);

    // Hide all the display fields and show and enable all the edit fields
    $(".display", "#property_row_" + id).css("visibility", "hidden");
    $(".edit", "#property_row_" + id).prop("disabled", false);
    $(".edit", "#property_row_" + id).css("visibility", "visible");

    // Fade out the unselected rows and disable the checkboxes on them
    $(".property_row:not(#property_row_" + id + ")").css("opacity", "0.5");
    $(".checkbox:not(#checkbox_" + id + ")").prop("disabled", true);

  } else {
    // WHEN A ROW IS DESELECTED..

    // Disable save button
    $("#save_btn_" + id).addClass("disabled")
                        .prop("disabled", true);

    // Hide and disable all the edit fields and display the display fields
    $(".edit", "#property_row_" + id).prop("disabled", true);
    $(".edit", "#property_row_" + id).css("visibility", "hidden");
    $(".display", "#property_row_" + id).css("visibility", "visible");

    // Fade all the other rows back in and enable all the checkboxes
    $(".property_row").css("opacity", "1");
    $(".checkbox").prop("disabled", false);
  }
}
</script>
